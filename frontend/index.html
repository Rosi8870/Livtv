<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live TV Player</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui;
  background: radial-gradient(circle at top, #1b2a3a, #05070c 70%);
  color: #fff;
}

/* ===== GLASS ===== */
.glass {
  background: rgba(255,255,255,0.10);
  backdrop-filter: blur(18px);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.15);
}

/* ===== HEADER ===== */
header {
  margin: 16px;
  padding: 18px;
  text-align: center;
  font-size: 22px;
  font-weight: 600;
}

/* ===== SEARCH ===== */
#searchBox {
  margin: 0 16px 14px;
  padding: 14px;
}
#search {
  width: 100%;
  padding: 16px;
  border-radius: 14px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
}

/* ===== LAYOUT ===== */
#layout {
  display: flex;
  gap: 16px;
  height: calc(100vh - 220px);
  padding: 0 16px;
}

/* ===== CHANNEL LIST ===== */
#channels {
  width: 34%;
  overflow-y: auto;
  padding: 8px;
  scrollbar-width: none;
}
#channels::-webkit-scrollbar { display: none; }

/* ===== SKELETON ===== */
.skeleton {
  height: 56px;
  margin-bottom: 12px;
  border-radius: 14px;
  background: linear-gradient(
    90deg,
    rgba(255,255,255,.08) 25%,
    rgba(255,255,255,.18) 37%,
    rgba(255,255,255,.08) 63%
  );
  background-size: 400% 100%;
  animation: shimmer 1.4s infinite;
}
@keyframes shimmer {
  0% { background-position: 100% 0 }
  100% { background-position: -100% 0 }
}

/* ===== CHANNEL CARD ===== */
.channel {
  display: flex;
  justify-content: space-between;
  padding: 16px;
  margin-bottom: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.08);
  cursor: pointer;
}
.channel:hover { background: rgba(255,255,255,0.16); }

.star { cursor: pointer; }

/* ===== PLAYER ===== */
#playerBox {
  flex: 1;
  position: relative;
  padding: 14px;
}
video {
  width: 100%;
  height: 100%;
  border-radius: 18px;
  background: black;
}

/* Hide timeline only */
video::-webkit-media-controls-timeline,
video::-webkit-media-controls-current-time-display,
video::-webkit-media-controls-time-remaining-display {
  display: none !important;
}

/* Player skeleton */
#playerSkeleton {
  position: absolute;
  inset: 14px;
  border-radius: 18px;
  background: linear-gradient(
    90deg,
    rgba(255,255,255,.08) 25%,
    rgba(255,255,255,.18) 37%,
    rgba(255,255,255,.08) 63%
  );
  background-size: 400% 100%;
  animation: shimmer 1.4s infinite;
  display: none;
}

/* ===== MOBILE ===== */
@media(max-width:900px){
  #layout { flex-direction: column; height:auto; }
  #playerBox { height: 38vh; }
  #channels { width:100%; max-height:52vh; }
}
</style>
</head>

<body>

<header class="glass">üì∫ Live TV Player</header>

<div id="searchBox" class="glass">
  <input id="search" placeholder="Search channels...">
</div>

<div id="layout">
  <div id="channels" class="glass">
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>

  <div id="playerBox" class="glass">
    <div id="playerSkeleton"></div>
    <video id="player" controls playsinline></video>
  </div>
</div>

<script>
/* ===== WEBSITE VIEW ANALYTICS (FIXED) ===== */
const today = new Date().toISOString().slice(0, 10);

/* Prevent multiple counts in same session */
if (!sessionStorage.getItem("countedVisit")) {
  let siteAnalytics = JSON.parse(localStorage.getItem("siteAnalytics") || "{}");

  siteAnalytics.totalViews = (siteAnalytics.totalViews || 0) + 1;
  siteAnalytics.days = siteAnalytics.days || {};
  siteAnalytics.days[today] = (siteAnalytics.days[today] || 0) + 1;
  siteAnalytics.lastVisit = new Date().toLocaleString();

  localStorage.setItem("siteAnalytics", JSON.stringify(siteAnalytics));
  sessionStorage.setItem("countedVisit", "true");
}
/* ===== LIVE TV PLAYER ===== */

const API = "https://livtv.onrender.com/channels";

const channelsEl = document.getElementById("channels");
const search = document.getElementById("search");
const video = document.getElementById("player");
const playerSkeleton = document.getElementById("playerSkeleton");

let channels = [];
let hls;

let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
let disabled  = JSON.parse(localStorage.getItem("disabledChannels") || "[]");
let analytics = JSON.parse(localStorage.getItem("analytics") || "{}");
let last = localStorage.getItem("lastChannel");

/* Load channels */
fetch(API).then(r=>r.json()).then(data=>{
  channels = data;
  render();
  if(last){
    const c = channels.find(x=>x.url===last);
    if(c && !disabled.includes(c.url)) play(c);
  }
});

function render(){
  channelsEl.innerHTML="";
  channels
    .filter(c=>!disabled.includes(c.url))
    .filter(c=>c.name.toLowerCase().includes(search.value.toLowerCase()))
    .forEach(c=>{
      const fav = favorites.includes(c.url);
      const div = document.createElement("div");
      div.className="channel";
      div.innerHTML = `
        <span>${c.name}</span>
        <span class="star">${fav?"‚≠ê":"‚òÜ"}</span>
      `;
      div.onclick = ()=>play(c);
      div.querySelector(".star").onclick = e=>{
        e.stopPropagation();
        toggleFav(c.url);
      };
      channelsEl.appendChild(div);
    });
}

function play(c){
  localStorage.setItem("lastChannel",c.url);
  playerSkeleton.style.display="block";
  if(hls) hls.destroy();

  if(Hls.isSupported()){
    hls=new Hls();
    hls.loadSource(c.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.FRAG_LOADED,()=>{
      playerSkeleton.style.display="none";
      video.play();
      record(c.name);
    });
  } else {
    video.src=c.url;
    video.onloadeddata=()=>{
      playerSkeleton.style.display="none";
      video.play();
      record(c.name);
    };
  }
}

function toggleFav(url){
  favorites = favorites.includes(url)
    ? favorites.filter(f=>f!==url)
    : [...favorites,url];
  localStorage.setItem("favorites",JSON.stringify(favorites));
  render();
}

function record(name){
  analytics.total=(analytics.total||0)+1;
  analytics[name]=(analytics[name]||0)+1;
  analytics.lastPlayed=name;
  analytics.lastTime=new Date().toLocaleString();
  localStorage.setItem("analytics",JSON.stringify(analytics));
}

search.oninput = render;
</script>

</body>
</html>
